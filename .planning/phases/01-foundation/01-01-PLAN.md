---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - bunfig.toml
  - src/types/ast.ts
  - src/types/errors.ts
  - src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Running `bun install` succeeds with all dependencies available"
    - "TypeScript compilation succeeds without errors"
    - "AST types cover all workflow node types (source, transform, sink, control flow)"
    - "Error types support source location attachment"
  artifacts:
    - package.json
    - tsconfig.json
    - src/types/ast.ts
    - src/types/errors.ts
    - src/types/index.ts
  key_links:
    - "AST types export WorkflowAST, NodeAST, SourceLocation"
    - "Error types export ValidationError with loc field"
---

<objective>
Initialize Bun project with all Phase 1 dependencies and create foundational type definitions for the FlowScript AST and validation errors.

Purpose: Establishes the project structure and type foundation that parser and validator will build upon
Output: Working Bun project with TypeScript, all dependencies installed, and complete AST type definitions
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Research findings to apply:
- Bun runtime with TypeScript
- Dependencies: fast-xml-parser, commander, @babel/code-frame, zod, chalk@4
- Project structure: src/parser/, src/validator/, src/cli/, src/types/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Bun project with dependencies</name>
  <files>package.json, tsconfig.json, bunfig.toml</files>
  <action>
    1. Run `bun init` in the repository root (accept defaults)
    2. Install production dependencies: `bun add fast-xml-parser commander @babel/code-frame zod chalk@4`
    3. Install dev dependencies: `bun add -d @types/node typescript`
    4. Configure tsconfig.json:
       - target: ESNext
       - module: ESNext
       - moduleResolution: bundler
       - strict: true
       - outDir: dist
       - rootDir: src
       - declaration: true
    5. Create bunfig.toml with:
       - [install] auto-install = false
    6. Update package.json:
       - name: "flowscript"
       - bin: { "flowscript": "./src/cli/index.ts" }
       - scripts: { "build": "bun build src/cli/index.ts --outdir dist", "typecheck": "tsc --noEmit" }
  </action>
  <verify>
    Run `bun install && bun run typecheck` - should complete without errors
  </verify>
  <done>
    - package.json exists with all dependencies listed
    - tsconfig.json exists with strict TypeScript configuration
    - bunfig.toml exists
    - `bun install` succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AST type definitions</name>
  <files>src/types/ast.ts</files>
  <action>
    Create comprehensive AST types based on the .flow.md file format:

    1. SourceLocation and Position types:
       ```typescript
       export interface Position {
         line: number;    // 1-indexed
         column: number;  // 0-indexed
         offset: number;  // Byte offset in source
       }

       export interface SourceLocation {
         start: Position;
         end: Position;
       }
       ```

    2. WorkflowMetadata (from YAML frontmatter):
       ```typescript
       export interface WorkflowMetadata {
         name: string;
         version: string;
         description?: string;
         trigger?: TriggerConfig;
         config?: Record<string, ConfigField>;
         secrets?: string[];
         schemas?: Record<string, unknown>;
       }

       export interface TriggerConfig {
         type: 'manual' | 'webhook' | 'schedule';
         config?: Record<string, unknown>;
       }

       export interface ConfigField {
         type: 'string' | 'number' | 'boolean' | 'object' | 'array';
         default?: unknown;
         required?: boolean;
         description?: string;
       }
       ```

    3. Base node types with discriminated unions:
       ```typescript
       export type NodeType = 'source' | 'transform' | 'sink' | 'branch' | 'if' | 'loop' | 'while' | 'foreach' | 'parallel' | 'checkpoint';

       export interface BaseNode {
         type: NodeType;
         id: string;
         loc: SourceLocation;
         input?: string;  // Reference to another node's output
       }

       export interface SourceNode extends BaseNode {
         type: 'source';
         sourceType: 'http' | 'file';
         config: Record<string, unknown>;
       }

       export interface TransformNode extends BaseNode {
         type: 'transform';
         transformType: 'ai' | 'template' | 'map' | 'filter';
         config: Record<string, unknown>;
       }

       export interface SinkNode extends BaseNode {
         type: 'sink';
         sinkType: 'http' | 'file';
         config: Record<string, unknown>;
       }

       // Control flow nodes
       export interface BranchNode extends BaseNode {
         type: 'branch';
         cases: BranchCase[];
         default?: NodeAST[];
       }

       export interface BranchCase {
         condition: string;
         nodes: NodeAST[];
         loc: SourceLocation;
       }

       export interface IfNode extends BaseNode {
         type: 'if';
         condition: string;
         then: NodeAST[];
         else?: NodeAST[];
       }

       export interface LoopNode extends BaseNode {
         type: 'loop';
         maxIterations?: number;
         breakCondition?: string;
         body: NodeAST[];
       }

       export interface WhileNode extends BaseNode {
         type: 'while';
         condition: string;
         body: NodeAST[];
       }

       export interface ForeachNode extends BaseNode {
         type: 'foreach';
         collection: string;
         itemVar: string;
         maxConcurrency?: number;
         body: NodeAST[];
       }

       export interface ParallelNode extends BaseNode {
         type: 'parallel';
         branches: NodeAST[][];
       }

       export interface CheckpointNode extends BaseNode {
         type: 'checkpoint';
         prompt: string;
         timeout?: number;
         defaultAction?: 'approve' | 'reject';
       }

       export type NodeAST =
         | SourceNode
         | TransformNode
         | SinkNode
         | BranchNode
         | IfNode
         | LoopNode
         | WhileNode
         | ForeachNode
         | ParallelNode
         | CheckpointNode;
       ```

    4. Complete workflow AST:
       ```typescript
       export interface WorkflowAST {
         metadata: WorkflowMetadata;
         nodes: NodeAST[];
         sourceMap: SourceMap;
       }

       export interface SourceMap {
         source: string;           // Original file content
         filePath: string;         // File path
         lineOffsets: number[];    // Byte offset for each line start
       }
       ```
  </action>
  <verify>
    Run `bun run typecheck` - should pass with no errors
  </verify>
  <done>
    - src/types/ast.ts exists with all AST types
    - Types are exported and can be imported
    - TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Create error type definitions and barrel export</name>
  <files>src/types/errors.ts, src/types/index.ts</files>
  <action>
    1. Create src/types/errors.ts with validation error types:
       ```typescript
       import type { SourceLocation } from './ast';

       export type ErrorSeverity = 'error' | 'warning';

       export type ErrorCode =
         // Parse errors
         | 'PARSE_YAML_INVALID'
         | 'PARSE_XML_INVALID'
         | 'PARSE_MISSING_FRONTMATTER'
         | 'PARSE_MISSING_BODY'
         // Structural validation
         | 'VALID_MISSING_REQUIRED_FIELD'
         | 'VALID_INVALID_FIELD_TYPE'
         | 'VALID_UNKNOWN_NODE_TYPE'
         // Reference validation
         | 'VALID_UNDEFINED_NODE_REF'
         | 'VALID_UNDEFINED_SECRET_REF'
         | 'VALID_DUPLICATE_NODE_ID'
         // Graph validation
         | 'VALID_CIRCULAR_DEPENDENCY';

       export interface ValidationError {
         code: ErrorCode;
         message: string;
         loc?: SourceLocation;
         severity: ErrorSeverity;
         hints?: string[];  // Suggestions for fixing
       }

       export interface ParseResult<T> {
         success: true;
         data: T;
       } | {
         success: false;
         errors: ValidationError[];
       }

       export interface ValidationResult {
         valid: boolean;
         errors: ValidationError[];
         warnings: ValidationError[];
       }

       // Helper to create errors with consistent structure
       export function createError(
         code: ErrorCode,
         message: string,
         loc?: SourceLocation,
         hints?: string[]
       ): ValidationError {
         return {
           code,
           message,
           loc,
           severity: 'error',
           hints
         };
       }

       export function createWarning(
         code: ErrorCode,
         message: string,
         loc?: SourceLocation,
         hints?: string[]
       ): ValidationError {
         return {
           code,
           message,
           loc,
           severity: 'warning',
           hints
         };
       }
       ```

    2. Create src/types/index.ts as barrel export:
       ```typescript
       export * from './ast';
       export * from './errors';
       ```
  </action>
  <verify>
    Run `bun run typecheck` - should pass with no errors
    Create a quick test: `echo "import { WorkflowAST, ValidationError } from './src/types'" | bun -`
  </verify>
  <done>
    - src/types/errors.ts exists with error types and helper functions
    - src/types/index.ts barrel exports all types
    - Types can be imported from 'src/types'
    - TypeScript compilation succeeds
  </done>
</task>

</tasks>

<verification>
Run these commands to verify the plan completed successfully:

```bash
# 1. Check package.json has all deps
bun pm ls | grep -E "(fast-xml-parser|commander|@babel/code-frame|zod|chalk)"

# 2. TypeScript compiles
bun run typecheck

# 3. Types are importable
echo "import { WorkflowAST, ValidationError, createError } from './src/types'; console.log('Types OK')" | bun -

# 4. Project structure exists
ls -la src/types/
```

All commands should succeed.
</verification>

<success_criteria>
- [ ] `bun install` completes successfully
- [ ] `bun run typecheck` passes with no errors
- [ ] All type files exist: src/types/ast.ts, src/types/errors.ts, src/types/index.ts
- [ ] Types are importable and usable
- [ ] package.json contains all required dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
