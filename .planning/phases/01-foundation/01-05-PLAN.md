---
phase: 01-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/parser/frontmatter.ts
  - src/parser/frontmatter.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Invalid version format produces clear error with line number"
    - "Semver pattern enforced: X.Y.Z or X.Y format"
    - "Error message suggests correct format"
  artifacts:
    - src/parser/frontmatter.ts
    - src/parser/frontmatter.test.ts
  key_links:
    - "parseFrontmatter validates version against semver regex"
---

<objective>
Add semver validation to YAML frontmatter version field.

Purpose: Close verification gap - invalid version formats like "bad version format" currently pass when they should fail.
Output: Strict semver validation with helpful error messages.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-VERIFICATION.md

Key insight from verification:
- parseFrontmatter only checks `typeof data.version !== 'string'`
- No regex validation for semver format
- Version "bad version format" passes when it should fail
- Required format: X.Y.Z (full semver) or X.Y (major.minor)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add semver validation to parseFrontmatter</name>
  <files>src/parser/frontmatter.ts</files>
  <action>
Add version format validation after the string type check:

```typescript
// After checking version is a string
if (typeof data.version !== 'string') {
  // existing error
}

// Add semver format validation
const semverPattern = /^\d+\.\d+(\.\d+)?$/;
if (typeof data.version === 'string' && !semverPattern.test(data.version)) {
  errors.push(
    createError(
      'VALID_INVALID_FIELD_TYPE',
      `Invalid version format "${data.version}"`,
      createLocation(frontmatterStart, frontmatterStart, lineOffsets),
      [
        'Version must be in semver format: X.Y.Z or X.Y',
        'Examples: "1.0.0", "2.1", "0.0.1"'
      ]
    )
  );
}
```

The pattern `/^\d+\.\d+(\.\d+)?$/` matches:
- "1.0.0" (full semver)
- "2.1" (major.minor)
- "0.0.1" (with leading zeros)

But rejects:
- "bad version format"
- "v1.0.0" (no v prefix)
- "1.0.0-beta" (no prerelease - keep simple for now)
  </action>
  <verify>bun run typecheck</verify>
  <done>parseFrontmatter validates version format</done>
</task>

<task type="auto">
  <name>Task 2: Add test coverage for version validation</name>
  <files>src/parser/frontmatter.test.ts</files>
  <action>
Add test cases for version format validation:

1. Test: Valid semver formats pass
```typescript
test('accepts valid semver versions', () => {
  const validVersions = ['1.0.0', '2.1', '0.0.1', '10.20.30'];
  for (const version of validVersions) {
    const yaml = `name: test\nversion: ${version}`;
    const result = parseFrontmatter(yaml, lineOffsets, 0);
    expect(result.success).toBe(true);
  }
});
```

2. Test: Invalid formats rejected
```typescript
test('rejects invalid version formats', () => {
  const invalidVersions = ['bad version', 'v1.0.0', '1', '1.0.0-beta', ''];
  for (const version of invalidVersions) {
    const yaml = `name: test\nversion: ${version}`;
    const result = parseFrontmatter(yaml, lineOffsets, 0);
    expect(result.success).toBe(false);
  }
});
```

3. Test: Error message is helpful
  </action>
  <verify>bun test src/parser/frontmatter.test.ts</verify>
  <done>All version validation tests pass</done>
</task>

</tasks>

<verification>
```bash
# Test invalid version rejected
cat > /tmp/bad-version.flow.md << 'EOF'
---
name: test
version: bad version format
---
<workflow>
  <source id="s1" type="http">
    <url>https://example.com</url>
  </source>
</workflow>
EOF

bun src/cli/index.ts validate /tmp/bad-version.flow.md
# Should exit 1 with error about invalid version format

# Test valid version accepted
cat > /tmp/good-version.flow.md << 'EOF'
---
name: test
version: 1.0.0
---
<workflow>
  <source id="s1" type="http">
    <url>https://example.com</url>
  </source>
</workflow>
EOF

bun src/cli/index.ts validate /tmp/good-version.flow.md
# Should exit 0
```
</verification>

<success_criteria>
- [ ] `bun src/cli/index.ts validate /tmp/bad-version.flow.md` exits 1
- [ ] Error message mentions invalid version format
- [ ] `bun src/cli/index.ts validate /tmp/good-version.flow.md` exits 0
- [ ] `bun test src/parser/frontmatter.test.ts` passes
- [ ] `bun run typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-05-SUMMARY.md`
</output>
