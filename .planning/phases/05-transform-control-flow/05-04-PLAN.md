---
phase: 05-transform-control-flow
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - src/runtimes/index.ts
  - src/runtimes/transform/transform.test.ts
  - src/runtimes/control/control.test.ts
autonomous: true

must_haves:
  truths:
    - "Transform runtimes registered and retrievable from global registry"
    - "Control runtimes registered and retrievable from global registry"
    - "Template runtime renders templates correctly"
    - "Map runtime transforms arrays with context injection"
    - "Filter runtime filters arrays correctly"
    - "Break and Goto throw correct signal types"
  artifacts:
    - path: "src/runtimes/index.ts"
      provides: "Complete runtime registry with all runtimes"
      contains: "runtimeRegistry.register"
    - path: "src/runtimes/transform/transform.test.ts"
      provides: "Transform runtime tests"
      min_lines: 50
    - path: "src/runtimes/control/control.test.ts"
      provides: "Control runtime tests"
      min_lines: 50
  key_links:
    - from: "src/runtimes/index.ts"
      to: "src/runtimes/transform/index.ts"
      via: "import and register"
      pattern: "import.*from.*transform"
    - from: "src/runtimes/index.ts"
      to: "src/runtimes/control/index.ts"
      via: "import and register"
      pattern: "import.*from.*control"
---

<objective>
Integrate transform and control runtimes into the global registry and add tests.

Purpose: Complete the phase by wiring new runtimes into the registry (making them discoverable) and validating behavior through tests.

Output:
- Updated `src/runtimes/index.ts` with new runtime registrations
- `src/runtimes/transform/transform.test.ts` - Transform runtime tests
- `src/runtimes/control/control.test.ts` - Control runtime tests
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Reference files:
@src/runtimes/index.ts (existing registry setup)
@src/runtimes/registry.ts (RuntimeRegistry class)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update runtime registry</name>
  <files>src/runtimes/index.ts</files>
  <action>
Add transform and control runtime registrations to the main runtimes index.

1. Import all transform runtimes:
   import { templateRuntime, mapRuntime, filterRuntime } from './transform';

2. Import all control runtimes:
   import { branchRuntime, ifRuntime, loopRuntime, whileRuntime, foreachRuntime, breakRuntime, gotoRuntime } from './control';

3. Register each runtime with the registry:
   runtimeRegistry.register(templateRuntime);
   runtimeRegistry.register(mapRuntime);
   runtimeRegistry.register(filterRuntime);
   runtimeRegistry.register(branchRuntime);
   runtimeRegistry.register(ifRuntime);
   runtimeRegistry.register(loopRuntime);
   runtimeRegistry.register(whileRuntime);
   runtimeRegistry.register(foreachRuntime);
   runtimeRegistry.register(breakRuntime);
   runtimeRegistry.register(gotoRuntime);

4. Re-export the new modules:
   export * from './transform';
   export * from './control';

Follow the existing pattern for HTTP and File runtime registration.
  </action>
  <verify>bun build src/runtimes/index.ts --no-bundle</verify>
  <done>
- All transform runtimes registered
- All control runtimes registered
- New modules re-exported
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create transform runtime tests</name>
  <files>src/runtimes/transform/transform.test.ts</files>
  <action>
Create tests for transform runtimes using Bun test framework.

Test templateRuntime:
- Template with simple expression: "Hello {{name}}" with name='World' -> "Hello World"
- Template with input access: "Value: {{input}}" with input=42 -> "Value: 42"
- Template with object field: "{{input.name}}" with input={name: 'Test'} -> "Test"

Test mapRuntime:
- Map array with expression: input=[1,2,3], expression="$item * 2" -> [2,4,6]
- Map with $index access: expression="$index" -> [0,1,2]
- Map with $first/$last: verify booleans are correct
- Map with single non-array input coerced to array

Test filterRuntime:
- Filter with condition: input=[1,2,3,4], condition="$item > 2" -> [3,4]
- Filter returns original items, not booleans
- Filter with $index condition: condition="$index > 0" -> [2,3,4]
- Filter with all false returns empty array

Use createEvalContext and minimal ExecutionState mocks. Import test utilities from bun:test.
  </action>
  <verify>bun test src/runtimes/transform/transform.test.ts</verify>
  <done>
- Template tests pass
- Map tests pass including context injection
- Filter tests pass including original item return
- All tests use Bun test framework
  </done>
</task>

<task type="auto">
  <name>Task 3: Create control runtime tests</name>
  <files>src/runtimes/control/control.test.ts</files>
  <action>
Create tests for control flow runtimes using Bun test framework.

Test breakRuntime:
- Throws BreakSignal when executed
- BreakSignal has correct targetLoopId when specified
- BreakSignal has undefined targetLoopId when not specified

Test gotoRuntime:
- Throws GotoSignal when executed
- GotoSignal has correct targetNodeId

Test BreakSignal class:
- instanceof BreakSignal works correctly
- name property is 'BreakSignal'

Test GotoSignal class:
- instanceof GotoSignal works correctly
- name property is 'GotoSignal'

Test branchRuntime and ifRuntime (basic):
- Returns correct match info structure
- Evaluates conditions correctly

Test loop metadata runtimes (basic):
- loopRuntime returns maxIterations
- whileRuntime returns condition and maxIterations
- foreachRuntime evaluates collection expression

Note: Full integration tests with body execution are for Phase 6 (Scheduling). These tests verify runtime behavior in isolation.
  </action>
  <verify>bun test src/runtimes/control/control.test.ts</verify>
  <done>
- Break/Goto signal tests pass
- Signal instanceof checks work correctly
- Branch/If runtime condition evaluation tests pass
- Loop metadata runtime tests pass
  </done>
</task>

</tasks>

<verification>
Phase 5 complete:
1. `bun test src/runtimes/transform/transform.test.ts` passes
2. `bun test src/runtimes/control/control.test.ts` passes
3. `bun build src/runtimes/index.ts --no-bundle` succeeds
4. Registry contains all new runtime types
</verification>

<success_criteria>
- Transform and control runtimes registered in global registry
- getRuntime('transform:template'), getRuntime('control:loop'), etc. all work
- Transform runtime tests verify correct behavior
- Control runtime tests verify signals and basic logic
- All tests pass with `bun test`
</success_criteria>

<output>
After completion, create `.planning/phases/05-transform-control-flow/05-04-SUMMARY.md`
</output>
