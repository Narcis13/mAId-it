---
phase: 08-full-cli
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/run.ts
  - src/cli/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can run `flowscript run workflow.flow.md` and workflow executes"
    - "User can run `flowscript run --dry-run workflow.flow.md` and see execution plan without running"
    - "User can provide `--config key=value` to override frontmatter config (repeatable)"
    - "User can provide `--input '{\"field\": \"value\"}'` as workflow input"
    - "Invalid file/parse/validation errors show clear messages and exit 1"
    - "Successful execution exits 0"
  artifacts:
    - src/cli/run.ts
  key_links:
    - "run.ts imports parseFile from ../parser"
    - "run.ts imports validate from ../validator"
    - "run.ts imports buildExecutionPlan from ../scheduler"
    - "run.ts imports createExecutionState, execute from ../execution"
    - "cli/index.ts imports runWorkflow from ./run"
---

<objective>
Implement the `flowscript run` command that executes workflow files with full option support.

Purpose: Enable users to execute workflows from the CLI, completing the core CLI experience for FlowScript v1.0. This wires together all the existing execution infrastructure (parser, validator, scheduler, executor) into a user-facing command.

Output: Working `flowscript run <file>` command with --dry-run, --config, --input, --format, and --no-color options.
</objective>

<execution_context>
@/Users/narcisbrindusescu/.claude/looppool/workflows/execute-plan.md
@/Users/narcisbrindusescu/.claude/looppool/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-full-cli/08-RESEARCH.md

# Existing CLI patterns to follow
@src/cli/validate.ts
@src/cli/index.ts
@src/cli/format.ts

# Execution infrastructure to wire
@src/parser/index.ts
@src/validator/index.ts
@src/scheduler/index.ts
@src/execution/index.ts
@src/execution/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install ora for progress display</name>
  <files>package.json</files>
  <action>
Install ora package for spinner-based progress display:
```bash
bun install ora
```

This is the only new dependency needed - all other libraries (commander, chalk) are already installed.
  </action>
  <verify>Check package.json contains ora dependency: `grep ora package.json`</verify>
  <done>ora appears in dependencies section of package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create run command module</name>
  <files>src/cli/run.ts</files>
  <action>
Create `src/cli/run.ts` following the validate.ts pattern. The module should:

1. **Types and interfaces:**
```typescript
export interface RunOptions {
  dryRun?: boolean;
  config?: string[];    // Array of 'key=value' strings from --config
  input?: string;       // JSON string from --input
  format?: 'text' | 'json';
  noColor?: boolean;
}

export interface RunResult {
  success: boolean;
  output: string;
  executionTime?: number;
}
```

2. **Main runWorkflow function:**
- Check file exists (Bun.file().exists())
- Parse file using parseFile from ../parser
- Return error if parse fails (format with formatParseErrors from ./format)
- Validate using validate from ../validator
- Return error if validation fails (format with formatValidationResult from ./format)
- Build execution plan using buildExecutionPlan from ../scheduler
- If --dry-run, return formatted execution plan (no execute)
- Parse config overrides from options.config array (key=value -> object)
- Parse input JSON from options.input (if provided)
- Create execution state with config overrides and input in globalContext
- Execute workflow using execute from ../execution
- Return success/failure result

3. **Helper functions:**
- `parseConfigOverrides(overrides: string[]): Record<string, unknown>` - parses key=value strings
- `formatExecutionPlan(plan: ExecutionPlan, color: boolean): string` - for dry-run output
- `formatExecutionResult(state: ExecutionState, color: boolean): string` - success output
- `formatExecutionError(error: Error, state: ExecutionState, color: boolean): string` - failure output

4. **Progress display:**
- Use ora spinner for execution progress
- Start spinner before execute()
- On success: spinner.succeed() with duration
- On failure: spinner.fail() with error message

5. **Error handling:**
- Invalid config format (missing =) throws helpful error
- Invalid JSON input throws helpful error
- All errors formatted consistently with existing CLI patterns
  </action>
  <verify>TypeScript compiles: `bun build src/cli/run.ts --no-bundle`</verify>
  <done>run.ts exports runWorkflow function with proper types and implementation</done>
</task>

<task type="auto">
  <name>Task 3: Register run command in CLI</name>
  <files>src/cli/index.ts</files>
  <action>
Add the run command to CLI entry point:

1. Import runWorkflow from ./run

2. Add collector function for repeatable options:
```typescript
function collectConfig(value: string, previous: string[]): string[] {
  return previous.concat([value]);
}
```

3. Register run command with commander:
```typescript
program
  .command('run')
  .description('Execute a .flow.md workflow')
  .argument('<file>', 'Workflow file to run')
  .option('--dry-run', 'Show execution plan without running')
  .option('-c, --config <key=value>', 'Override config value (repeatable)', collectConfig, [])
  .option('--input <json>', 'Workflow input data as JSON')
  .option('-f, --format <format>', 'Output format (text, json)', 'text')
  .option('--no-color', 'Disable colored output')
  .action(async (file: string, options) => {
    const result = await runWorkflow(file, {
      dryRun: options.dryRun,
      config: options.config,
      input: options.input,
      format: options.format === 'json' ? 'json' : 'text',
      noColor: options.color === false,
    });

    console.log(result.output);
    process.exit(result.success ? 0 : 1);
  });
```

Place run command registration after validate command.
  </action>
  <verify>CLI help shows run command: `bun src/cli/index.ts run --help`</verify>
  <done>flowscript run command registered with all options visible in --help</done>
</task>

</tasks>

<verification>
Run these commands to verify the implementation:

1. **Help text shows run command:**
   ```bash
   bun src/cli/index.ts --help
   bun src/cli/index.ts run --help
   ```

2. **Dry-run shows execution plan:**
   ```bash
   bun src/cli/index.ts run --dry-run examples/simple.flow.md
   ```
   (Create a simple test workflow if needed)

3. **Config override parsing:**
   ```bash
   bun src/cli/index.ts run --dry-run -c output_dir=./out -c timeout=30 examples/simple.flow.md
   ```

4. **Input JSON parsing:**
   ```bash
   bun src/cli/index.ts run --dry-run --input '{"name": "test"}' examples/simple.flow.md
   ```

5. **Error handling for invalid file:**
   ```bash
   bun src/cli/index.ts run nonexistent.flow.md
   echo $?  # Should be 1
   ```

6. **TypeScript compilation:**
   ```bash
   bun run typecheck
   ```
</verification>

<success_criteria>
- [ ] ora installed and in package.json
- [ ] src/cli/run.ts exists with runWorkflow export
- [ ] `flowscript run --help` shows all options (--dry-run, -c/--config, --input, -f/--format, --no-color)
- [ ] `flowscript run --dry-run <file>` shows execution plan without running
- [ ] `flowscript run -c key=value` accepts multiple config overrides
- [ ] `flowscript run --input '{"key":"value"}'` parses JSON input
- [ ] Invalid file returns exit code 1
- [ ] Parse/validation errors formatted consistently with validate command
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-full-cli/08-01-SUMMARY.md`
</output>
